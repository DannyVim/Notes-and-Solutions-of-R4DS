---
title: "Rnotes to the R4DS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Exercises 7.3

> 1.  Explore the distribution of each of the `x`, `y`, and `z` variables in `diamonds`.
>     What do you learn?
>     Think about a diamond and how you might decide which dimension is the length, width, and depth.

三维的数据中最小值都有零的，应该是数据错误，应该剔除。

`coord_cartesian()`一定要加上，不然就需要删除离散点，否则难以作比较(应该是离散值分布的缘故)。

从分布上来看，x、y一般比z大；但x、y之间不容区分。

```{r 7.3.1}
diamonds %>% select(x,y,z) %>% summary()

x <-
  diamonds %>% ggplot() + geom_histogram(aes(x = x), binwidth = 0.01) + labs(x = 'x:length') + coord_cartesian(xlim = c(0, 10))
y <-
  diamonds %>% ggplot() + geom_histogram(aes(x = y), binwidth = 0.01) + labs(x = 'y:width') + coord_cartesian(xlim = c(0, 10))
z <-
  diamonds %>% ggplot() + geom_histogram(aes(x = z), binwidth = 0.01) + labs(x = 'z:depth') + coord_cartesian(xlim = c(0, 10))

patchwork::wrap_plots(x/y/z) # 把三张图排在一起

# 比较xz和yz，jrnold给了一个简单的方法
summarise(diamonds, mean(x > y), mean(x > z), mean(y > z))
```

> 2.  Explore the distribution of `price`.
>     Do you discover anything unusual or surprising?
>     (Hint: Carefully think about the `binwidth` and make sure you try a wide range of values.)

首先整体图像左偏，其次中间一段明显有缺口。

通过不断调整`coord_cartesian(xlim = ... )`，有缺口的部分大抵在1500±250的范围内。

```{r 7.3.2}
diamonds %>% ggplot() + geom_histogram(aes(x = price), binwidth = 10)
diamonds %>% ggplot() + geom_histogram(aes(x = price), binwidth = 10) + coord_cartesian(xlim = c(1250, 1750))
```

> 3.  How many diamonds are 0.99 carat?
>     How many are 1 carat?
>     What do you think is the cause of the difference?

1克拉的数量远多于0.99克拉，因为0.01克拉的差距将导致约800元的价格差距。

```{r 7.3.3}
diamonds %>% select(carat,price) %>% filter(carat %in% c(0.99,1)) %>% group_by(carat) %>% summarise(n=n(),mean(price))
```

> 4.  Compare and contrast `coord_cartesian()` vs `xlim()` or `ylim()` when zooming in on a histogram.
>     What happens if you leave `binwidth` unset?
>     What happens if you try and zoom so only half a bar shows?

`coord_cartesian()`只是zooming，相当于是放大镜一样；而后两个则是把范围之外的值直接抛弃，并不进行计算（如果想要算得快一些，后者可能更好）。

`R`会分配一个默认的`binwidth`（通常是30）。

# Exercises 7.4

>1.  What happens to missing values in a histogram?
>    What happens to missing values in a bar chart?
>    Why is there a difference?

`histogram`会提示忽略掉`NA`，而`bar chart`则会计算`NA`的数量（非数字类型变量）。

```{r 7.4.1}
diamonds %>% mutate(y = ifelse(y < 3 | y > 20, NA, y)) %>% ggplot() + geom_histogram(aes(x = y))
diamonds %>% mutate(cut = ifelse(y < 3 | y > 20, NA, cut)) %>% ggplot() + geom_bar(aes(x = as.character(cut)))
```

> 2.  What does `na.rm = TRUE` do in `mean()` and `sum()`?

计算时忽略NA，有时NA会导致计算错误。

# Exercises 7.5

> 1.  Use what you've learned to improve the visualisation of the departure times of cancelled vs. non-cancelled flights.

```{r 7.5.1}
nycflights13::flights %>% 
  mutate(
    cancelled = is.na(dep_time),
    sched_hour = sched_dep_time %/% 100,
    sched_min = sched_dep_time %% 100,
    sched_dep_time = sched_hour + sched_min / 60
  ) %>% ggplot(mapping = aes(x=sched_dep_time)) + 
  geom_density(mapping = aes(fill = cancelled), alpha = 0.30)

nycflights13::flights %>% 
  mutate(
    cancelled = is.na(dep_time),
    sched_hour = sched_dep_time %/% 100,
    sched_min = sched_dep_time %% 100,
    sched_dep_time = sched_hour + sched_min / 60
  ) %>%   ggplot() + 
  geom_boxplot(mapping = aes(x = cancelled, y = sched_dep_time))
```

>2.  What variable in the diamonds dataset is most important for predicting the price of a diamond?
>    How is that variable correlated with cut?
>    Why does the combination of those two relationships lead to lower quality diamonds being more expensive?

很明显，`carat`会是最重要的因素。`carat`和`cut`的联系并不密切，虽然`cut`差，但奈何不了`carat`大啊。

```{r 7.5.2}
cor(diamonds$price, select(diamonds, carat, depth, table))

lm(price ~ carat + cut + color + table + clarity, data = diamonds) %>% summary.lm()

diamonds %>% ggplot(aes(x=cut,y=carat))+geom_boxplot()
```

>3.  Exchange x variable and y variable in a vertical boxplot, and create a horizontal boxplot.
>    How does this compare to using `coord_flip()`?

```{r 7.5.3}
diamonds %>% ggplot(aes(y = cut, x = carat)) + geom_boxplot()
diamonds %>% ggplot(aes(y = cut, x = carat)) + geom_boxplot() + coord_flip()
```

>4.  One problem with boxplots is that they were developed in an era of much smaller datasets and tend to display a prohibitively large number of "outlying values". One approach to remedy this problem is the letter value plot.
>    Install the `lvplot` package, and try using `geom_lv()` to display the distribution of price vs cut.
>    What do you learn?
>    How do you interpret the plots?

https://doi.org/10.1080/10618600.2017.1305277

```{r 7.5.4}
ggplot(data = diamonds, aes(x = cut, y = price)) + lvplot::geom_lv(aes(fill = ..LV..))
```

>5.  Compare and contrast `geom_violin()` with a facetted `geom_histogram()`, or a coloured `geom_freqpoly()`.
>    What are the pros and cons of each method?

```{r 7.5.5}
p <- nycflights13::flights %>% 
  mutate(
    cancelled = is.na(dep_time),
    sched_hour = sched_dep_time %/% 100,
    sched_min = sched_dep_time %% 100,
    sched_dep_time = sched_hour + sched_min / 60
  ) %>% ggplot() 
p + geom_violin(mapping = aes(x = cancelled, y = sched_dep_time))
p + geom_histogram(mapping = aes(x = sched_dep_time)) + facet_wrap(~cancelled)
p + geom_freqpoly(mapping = aes(x = sched_dep_time,y = ..density.., colour = cancelled))
```

>6.  If you have a small dataset, it's sometimes useful to use `geom_jitter()` to see the relationship between a continuous and categorical variable. The `ggbeeswarm` package provides a number of methods similar to `geom_jitter()`.
>    List them and briefly describe what each one does.

- `geom_beeswarm`: 在横向水平上扰动

- `geom-quasirandom`: 随机扰动

这两个变量会将图像调整成小提琴图的样式。

```{r 7.5.6}
ggplot(mpg, aes(y = displ, x = drv, color = drv))+
  geom_jitter()

ggplot(mpg, aes(y = displ, x = drv, color = drv))+
  ggbeeswarm::geom_beeswarm()

ggplot(mpg, aes(y = displ, x = drv, color = drv))+
  ggbeeswarm::geom_quasirandom()
```

